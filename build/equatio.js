var E={vars:{t:0,s:0,td:1,x:0,y:0,mx:0,my:0,mld:0,mmd:0,mrd:0,rms:1},paused:!1,lastSec:0};
$(function(){E.polyfill();E.examples.load();E.graphics.load();E.sound.load();setTimeout(function(){$("#speed").simpleSlider("setValue",1);$("#volume").simpleSlider("setValue",0.5);E.sharing.load()},500);$("#sharebutton").bind("click",E.sharing.share);$("#urlbutton").bind("click",E.sharing.showURL);$("#resetbutton").bind("click",E.reset);$("#playbutton").bind("click",function(a){E.pause()});$("#backbutton").bind("click",E.back);$("#screen").bind("mousemove",function(a){E.vars.mx=a.offsetX;E.vars.my=
a.offsetY});$("#screen").bind("mousedown",function(a){0==a.button?E.vars.mld=1:1==a.button?E.vars.mmd=1:2==a.button&&(E.vars.mrd=1)});$("#screen").bind("mouseup",function(a){0==a.button?E.vars.mld=0:1==a.button?E.vars.mmd=0:2==a.button&&(E.vars.mrd=0)});$("#screen").bind("mouseleave",function(a){E.mld=E.mmd=E.mrd=0});$("#screen").bind("contextmenu",function(a){return!1});$("#examples").bind("change",function(a){E.examples.select($("#examples").val())});$("#gfxactive").bind("change",function(a){E.graphics.toggle($("#gfxactive")[0].checked)});
$("#sfxactive").bind("change",function(a){E.paused?E.sound.active=$("#sfxactive")[0].checked:E.sound.set($("#sfxactive")[0].checked)});$("#volume").bind("change",function(a){E.sound.gain.value.setValue(a.value)});$("#speed").bind("change",function(a){E.setSpeed(a.value)});$("#gfxcode").bind("blur",function(a){E.graphics.setCode(a.target.value)});$("#sfxcode").bind("blur",function(a){E.sound.setCode(a.target.value)});requestAnimationFrame(E.update)});
E.update=function(){E.vars.t+=E.vars.td;E.graphics.active&&E.graphics.draw();$("#time").text(Math.floor(E.vars.t/60)+" sec");E.lastSec=E.vars.t;E.paused||requestAnimationFrame(E.update)};E.reset=function(){$("#gfxcode").text("");$("#sfxcode").text("");E.graphics.reset();E.sound.reset()};E.setSpeed=function(a){$("#speedview").text(Math.round(10*a)/10+"x");$("#speed").simpleSlider("setValue",a);E.vars.td=a};
E.polyfill=function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var e=(new Date).getTime(),f=Math.max(0,16-(e-a)),g=window.setTimeout(function(){b(e+f)},f);a=e+f;return g});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(a){clearTimeout(a)})};E.pause=function(a){if(null==a)a=!E.paused;else if(a==E.paused)return;a?E.sound.disconnect():(requestAnimationFrame(E.update),E.sound.active&&E.sound.connect());E.paused=a;$("#playbutton")[0].src=a?"img/play.png":"img/pause.png"};E.back=function(){E.vars.t=0;E.vars.s=0;E.graphics.active&&E.graphics.draw();$("#time").text("0 sec")};E.reset=function(){$("#gfxcode")[0].value="";$("#sfxcode")[0].value="";E.graphics.reset();E.sound.reset();E.pause(!0)};E.examples={};E.examples.list={"munching squares":["(x^y)*(t/100)"],"munching triangles":["(x&y)*(t/100)"],noise:["(function(){var n=Math.random()*0xFF;return n<<16|n<<8|n;})()","Math.random()*255",1,0.3],mandelbrot:["(function(){var it;var jx=jy=0.0;for(it=0;it<10&&jx*jx+jy*jy<=4;++it){var tmp=2*jx*jy;jx=jx*jx-jy*jy+(-2+3*x/255);jy=tmp+(-1+2*y/255);};return Math.pow(it,5);})()"],unnamed1:["x<<t>>y","s<<t>>s",1,0.3],tejeez:["(((50*s)/50)*(((50*s)/50)>>5|(s)>>8))>>((50*s/50)>>16)*(x^y)","(((50*s)/50)*(((50*s)/50)>>5|(s)>>8))>>((50*s/50)>>16)"]};
E.examples.load=function(){var a=E.examples.list,b;for(b in E.examples.list)a.hasOwnProperty(b)&&$("<option>"+b+"</option>").appendTo($("#examples"))};
E.examples.select=function(a){var b=E.examples.list;if(b.hasOwnProperty(a)){var c=b[a][0]||"",d=b[a][1]||"";E.back();E.graphics.setCode(c);E.sound.setCode(d);$("#gfxcode")[0].value=c;$("#sfxcode")[0].value=d;""!=c?E.graphics.toggle(!0):E.graphics.toggle(!1);""!=d?E.sound.set(!0):E.sound.set(!1);E.setSpeed(b[a][2]||1);E.sound.setVolume(b[a][3]||0.5);E.pause(!1)}};E.graphics={};E.graphics.active=!0;E.graphics.load=function(){E.graphics.context=$("#screen")[0].getContext("2d");E.graphics.imageData=E.graphics.context.getImageData(0,0,256,256);E.graphics.buffer=new ArrayBuffer(E.graphics.imageData.data.length);E.graphics.buffer8=new Uint8ClampedArray(E.graphics.buffer);E.graphics.data=new Uint32Array(E.graphics.buffer)};E.graphics.toggle=function(a){(E.graphics.active=a)?E.graphics.draw():E.graphics.context.clearRect(0,0,256,256);$("#gfxactive")[0].checked=a};
E.graphics.draw=function(){};
E.graphics.setCode=function(a){$("#gfxerror").css("color","#050");if(""==a)$("#gfxerror").text("No code"),E.graphics.reset();else{try{eval(a)}catch(b){var c=b.message.split(" ")[0];if(!E.vars.hasOwnProperty(c)&&"rd"!=c){E.graphics.reset();$("#gfxerror").css("color","#900").text(b.message);return}}E.graphics.draw=new Function("var s = E.vars.s, t = E.vars.t, td = E.vars.td, mx = E.vars.mx, my = E.vars.my;        var rd = Math.random()*256, mld = E.vars.mld, mrd = E.vars.mrd, mmd = E.vars.mmd, rms = E.vars.rms;        for (var y = 0; y < 256; y++) {            for (var x = 0; x < 256; x++) {                E.graphics.data[y * 256 + x] = (255 << 24) | ("+a+
");            }        }        E.graphics.imageData.data.set(E.graphics.buffer8);        E.graphics.context.putImageData(E.graphics.imageData, 0, 0);");try{E.graphics.draw(),$("#gfxerror").text("No error"),E.graphics.active||E.graphics.context.clearRect(0,0,256,256)}catch(d){E.graphics.reset(),$("#gfxerror").css("color","#900").text(d.message)}}};E.graphics.reset=function(){E.graphics.draw=function(){};E.graphics.context.clearRect(0,0,256,256)};E.sharing={};E.sharing.set=function(a,b){switch(a){case "gfx":E.graphics.toggle(b);break;case "sfx":E.sound.set(b);break;case "gfxcode":E.graphics.setCode(b);$("#gfxcode")[0].value=b;break;case "sfxcode":E.sound.setCode(b);$("#sfxcode")[0].value=b;break;case "paused":E.pause(b);break;case "volume":E.sound.setVolume(b);break;case "td":E.setSpeed(b);break;case "t":E.vars.t=b;$("#time").text(Math.floor(b/60)+" sec");break;case "s":E.vars.s=b}};
E.sharing.load=function(){var a=document.location.search;if(""!=a)for(var a=a.substring(1),a=a.split("&"),b=0;b<a.length;++b){var c=a[b].split("=")[0],d=a[b].split("=")[1];"false"==d?d=!1:"true"==d?d=!0:(nvalue=parseFloat(d),d=isNaN(nvalue)?decodeURIComponent(d):nvalue);console.log(c,d);E.sharing.set(c,d)}};E.sharing.shorten=function(a,b,c,d){$.getJSON(d?"http://v.gd/create.php":"http://is.gd/create.php","format=json&url="+encodeURIComponent(a),b).error(c)};
E.sharing.build=function(){var a=document.location.origin+document.location.pathname+"?",a=a+("gfx="+E.graphics.active),a=a+("&sfx="+E.sound.active),b=$("#gfxcode").val();""!=b&&E.graphics.active&&(a+="&gfxcode="+encodeURIComponent(b));b=$("#sfxcode").val();""!=b&&E.sound.active&&(a+="&sfxcode="+encodeURIComponent(b));a+="&paused="+E.paused;a+="&volume="+Math.round(100*E.sound.gain.value.getValue())/100;a+="&td="+Math.round(100*E.vars.td)/100;a+="&t="+E.vars.t;return a+="&s="+E.vars.s};
E.sharing.share=function(){function a(){b.css("color","#900").text("Error");setTimeout(function(){b.css("color","#333").text("Share!")},2E3)}var b=$("#sharebutton");b.css("color","#050").text("Please wait");E.sharing.shorten(E.sharing.build(),function(c,d,h){b.css("color","#333").text("Share!");c.shorturl?prompt("Your link was shortened. You can copypaste it and share your creation with others.\n\nTip: Append a '-' at the end of this URL to show a preview before redirecting to equatio.",c.shorturl):
a()},a,!1)};E.sharing.showURL=function(){var a=E.sharing.build();prompt("You can copypaste this link to store your creation or share it with others.\n\nTip: Click on the 'Share!' button instead to generate a shortened version of this link.",a)};E.sound={};E.sound.active=!1;E.sound.connected=!1;E.sound.load=function(){E.sound.audiolet=new Audiolet;E.sound.gain=new Gain(E.sound.audiolet);E.sound.node=new E.sound.EquatioNode(E.sound.audiolet);E.sound.node.connect(E.sound.gain);E.sound.gain.value.setValue(0.5)};E.sound.connect=function(){E.sound.connected||(E.sound.gain.connect(E.sound.audiolet.device),E.sound.connected=!0)};E.sound.disconnect=function(){E.sound.gain.disconnect(E.sound.audiolet.device);E.sound.connected=!1};
E.sound.set=function(a){a?E.sound.connect():E.sound.disconnect();E.sound.active=a;$("#sfxactive")[0].checked=a};
E.sound.setCode=function(a){$("#sfxerror").css("color","#050");if(""==a)$("#sfxerror").text("No code"),E.sound.reset();else{try{eval(a)}catch(b){if(!E.vars.hasOwnProperty(b.message.split(" ")[0])){E.sound.reset();$("#sfxerror").css("color","#900").text(b.message);return}}E.sound.EquatioNode.prototype.generate=new Function("inputBuffers","outputBuffers","var s = E.vars.s, t = E.vars.t, td = E.vars.td, mx = E.vars.mx, my = E.vars.my;        var mld = E.vars.mld, mrd = E.vars.mrd, mmd = E.vars.mmd;        var output = this.outputs[0];        E.output = output;        for (var i = 0; i < output.samples.length; i++) {            output.samples[i] = ("+a+
") % 256 / 256;            s += td;        }        E.vars.s = s;        if (output.samples.length >= 1)            E.vars.rms = (E.vars.rms + output.samples[0]) / 2;");try{E.sound.node.generate(),$("#sfxerror").text("No error")}catch(c){E.sound.reset(),$("#sfxerror").css("color","#900").text(c.message)}}};E.sound.reset=function(){E.sound.EquatioNode.prototype.generate=function(){}};E.sound.setVolume=function(a){$("#volume").simpleSlider("setValue",a);E.sound.gain.value.setValue(a)};
E.sound.EquatioNode=function(a,b){AudioletNode.call(this,a,0,2);this.linkNumberOfOutputChannels(0,2)};extend(E.sound.EquatioNode,AudioletNode);E.sound.EquatioNode.prototype.generate=function(a,b){};E.sound.EquatioNode.prototype.toString=function(){return"EquatioNode"};
